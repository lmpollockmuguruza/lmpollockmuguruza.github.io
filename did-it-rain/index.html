<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>did it rain? — london · manchester</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300;1,9..40,400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
    --bg:#f5f1eb;--bg-card:#ece8e0;--bg-deep:#e3ded5;
    --ink:#1a1714;--ink-s:#3d3830;--ink-m:#7a7368;--ink-f:#a09890;--ink-g:#c8c2b8;
    --blue:#3d6a9f;--blue-h:#2d5580;--blue-p:#a8c8e8;--blue-w:rgba(61,106,159,.07);--blue-gl:rgba(61,106,159,.14);
    --dry:#b8935a;--dry-w:rgba(184,147,90,.07);--dry-gl:rgba(184,147,90,.14);
    --brd:rgba(26,24,22,.07);
    --r:20px;--rs:12px;
    --e:cubic-bezier(.4,0,.2,1);--es:cubic-bezier(.16,1,.3,1);
    --spring:cubic-bezier(.34,1.56,.64,1);
    --section-r:28px;
    --glass-bg:rgba(255,255,255,.45);--glass-brd:rgba(255,255,255,.65);--glass-sh:0 8px 32px rgba(0,0,0,.06),0 1px 4px rgba(0,0,0,.04);--glass-blur:20px;
}
[data-theme="dark"]{
    --bg:#111010;--bg-card:#1a1918;--bg-deep:#141312;
    --ink:#e8e4dd;--ink-s:#c8c2b8;--ink-m:#8a8279;--ink-f:#5a554e;--ink-g:#2e2b28;
    --blue:#7baaf0;--blue-h:#9dc4ff;--blue-p:#4a6a8f;--blue-w:rgba(123,170,240,.08);--blue-gl:rgba(123,170,240,.15);
    --dry:#ddb070;--dry-w:rgba(221,176,112,.08);--dry-gl:rgba(221,176,112,.15);
    --brd:rgba(232,228,221,.06);
    --glass-bg:rgba(30,28,26,.5);--glass-brd:rgba(255,255,255,.08);--glass-sh:0 8px 32px rgba(0,0,0,.2);
}
html{font-size:16px;-webkit-font-smoothing:antialiased;scroll-behavior:smooth}
body{font-family:'DM Sans',-apple-system,sans-serif;background:var(--bg);color:var(--ink-s);min-height:100vh;line-height:1.6;transition:background .5s var(--e),color .5s var(--e);overflow-x:hidden}
::selection{background:rgba(61,106,159,.2);color:var(--ink)}

/* TOPBAR */
.topbar{position:fixed;top:0;left:0;right:0;z-index:500;padding:1.1rem 2.2rem;display:flex;align-items:center;justify-content:space-between;transition:all .4s var(--e)}
.topbar.scrolled{background:var(--bg);border-bottom:1px solid var(--brd)}
.back-link{display:inline-flex;align-items:center;gap:.45rem;font-family:'DM Mono',monospace;font-size:.7rem;font-weight:400;color:var(--ink-m);text-decoration:none;letter-spacing:.01em;transition:color .3s var(--e)}
.back-link:hover{color:var(--blue)}
.back-link svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:1.5;transition:transform .3s var(--e)}
.back-link:hover svg{transform:translateX(-3px)}
.topbar-right{display:flex;align-items:center;gap:.6rem}
.icon-btn{display:flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid var(--brd);border-radius:50%;background:transparent;cursor:pointer;transition:all .3s var(--e);color:var(--ink-f)}
.icon-btn:hover{border-color:var(--blue-gl);color:var(--blue);background:var(--blue-w)}
.icon-btn svg{width:14px;height:14px;fill:currentColor;transition:transform .4s var(--es)}
.icon-btn:hover svg{transform:rotate(20deg)}
.icon-btn .icon-sun{display:none}.icon-btn .icon-moon{display:block}
[data-theme="dark"] .icon-btn .icon-sun{display:block}[data-theme="dark"] .icon-btn .icon-moon{display:none}

/* SCROLL HERO */
.scroll-hero{position:relative;height:155vh;overflow:hidden}
.scroll-hero-sticky{position:sticky;top:0;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
.hero-text{position:relative;z-index:1;text-align:center;pointer-events:none}
.hero-line-1{font-family:'Instrument Serif',Georgia,serif;font-size:5.5rem;font-weight:400;letter-spacing:-.05em;line-height:.9;color:var(--ink);opacity:0;transform:translateY(30px);transition:all .8s var(--es)}
.hero-line-1.vis{opacity:1;transform:translateY(0)}
.hero-line-2{font-family:'Instrument Serif',Georgia,serif;font-size:7rem;font-weight:400;font-style:italic;letter-spacing:-.05em;line-height:.85;color:var(--blue);opacity:0;transform:translateY(40px);transition:all .9s var(--es) .15s}
.hero-line-2.vis{opacity:1;transform:translateY(0)}
.hero-lbl{font-family:'DM Mono',monospace;font-size:.55rem;font-weight:400;letter-spacing:.18em;text-transform:uppercase;color:var(--ink-f);margin-bottom:1rem;opacity:0;transform:translateY(15px);transition:all .6s var(--es);display:flex;align-items:center;justify-content:center;gap:.5rem}
.hero-lbl::before,.hero-lbl::after{content:'';width:5px;height:5px;border-radius:1px;background:var(--ink-g);display:inline-block}
.hero-lbl.vis{opacity:1;transform:translateY(0)}
.hero-sub{font-size:.85rem;color:var(--ink-m);margin-top:1.5rem;line-height:1.65;max-width:340px;margin-left:auto;margin-right:auto;opacity:0;transform:translateY(20px);transition:all .7s var(--es) .35s}
.hero-sub.vis{opacity:1;transform:translateY(0)}
.hero-sub em{font-family:'Instrument Serif',Georgia,serif;font-size:.95rem;color:var(--ink-s);font-style:italic}
.scroll-hint{position:absolute;bottom:2.5rem;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.5rem;opacity:0;transition:opacity .6s var(--e) .8s;z-index:1}
.scroll-hint.vis{opacity:1}
.scroll-hint-label{font-family:'DM Mono',monospace;font-size:.5rem;letter-spacing:.15em;text-transform:uppercase;color:var(--ink-f)}
.scroll-hint-line{width:1px;height:28px;background:linear-gradient(to bottom,var(--ink-f),transparent);animation:scrollPulse 2s ease-in-out infinite}
@keyframes scrollPulse{0%,100%{opacity:.3;transform:scaleY(.7)}50%{opacity:1;transform:scaleY(1)}}

/* PAGE */
.page{max-width:680px;margin:0 auto;padding:0 2rem;position:relative;z-index:1}

/* CITY SWITCHER */
.city-sw{display:flex;justify-content:center;margin:0 auto 2.5rem;padding:4px;max-width:260px;border-radius:100px;background:var(--bg-card);border:1px solid var(--brd)}
.city-btn{flex:1;padding:.55rem 1rem;font-family:'DM Mono',monospace;font-size:.68rem;font-weight:400;letter-spacing:.04em;border:none;border-radius:100px;background:transparent;color:var(--ink-f);cursor:pointer;transition:all .3s var(--e)}
.city-btn.active{background:var(--blue);color:#fff;box-shadow:0 2px 12px rgba(61,106,159,.3)}
[data-theme="dark"] .city-btn.active{box-shadow:0 2px 12px rgba(123,170,240,.2)}
.city-btn:not(.active):hover{color:var(--ink-s)}

/* SECTION PANELS */
.section-panel{background:var(--bg-card);border-radius:var(--section-r);padding:2.5rem 2.25rem;margin-bottom:1rem;border:1px solid var(--brd);opacity:0;transform:translateY(24px);transition:opacity .6s var(--es),transform .6s var(--es)}
.section-panel.revealed{opacity:1;transform:translateY(0)}

/* STREAK CARD */
.mc{position:relative;overflow:hidden;transition:all .5s var(--e)}
.mc-mood{position:absolute;inset:0;pointer-events:none;border-radius:var(--section-r);z-index:0;opacity:.35;transition:opacity 1s var(--e)}
.mc.raining .mc-mood{background:radial-gradient(ellipse at 30% 20%,rgba(61,106,159,.15),transparent 70%),radial-gradient(ellipse at 70% 80%,rgba(100,160,220,.1),transparent 60%);animation:moodShift 8s ease-in-out infinite alternate}
.mc.dry .mc-mood{background:radial-gradient(ellipse at 30% 20%,rgba(184,147,90,.12),transparent 70%),radial-gradient(ellipse at 70% 80%,rgba(220,180,110,.08),transparent 60%);animation:moodShift 10s ease-in-out infinite alternate}
[data-theme="dark"] .mc-mood{opacity:.2}
@keyframes moodShift{0%{transform:scale(1) rotate(0deg)}100%{transform:scale(1.1) rotate(3deg)}}

.pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .7rem;border-radius:100px;font-family:'DM Mono',monospace;font-size:.55rem;font-weight:400;letter-spacing:.08em;text-transform:uppercase}
.pill.rp{background:var(--blue-w);color:var(--blue);border:1px solid var(--blue-gl)}
.pill.dp{background:var(--dry-w);color:var(--dry);border:1px solid var(--dry-gl)}
.pdot{width:5px;height:5px;border-radius:50%;animation:pls 2s ease-in-out infinite}
.rp .pdot{background:var(--blue)}.dp .pdot{background:var(--dry)}
@keyframes pls{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(.6)}}

/* DIGIT ROLLER */
.sd{text-align:center;margin-top:.5rem}
.digit-roller{display:inline-flex;justify-content:center;align-items:flex-end;overflow:visible;height:1em;line-height:1;font-family:'Instrument Serif',Georgia,serif;font-size:9rem;font-weight:400;letter-spacing:-.03em}
.digit-col{display:inline-block;width:.58em;height:1em;overflow:hidden;position:relative}
.digit-strip{display:flex;flex-direction:column;transition:transform .7s var(--spring)}
.digit-strip span{display:block;width:100%;height:1em;line-height:1;text-align:center}
.mc.raining .digit-roller{color:var(--blue)}.mc.dry .digit-roller{color:var(--dry)}
.digit-roller.breathing{animation:breathe 4s ease-in-out infinite}
@keyframes breathe{0%,100%{transform:scale(1)}50%{transform:scale(1.012)}}
.su{display:block;font-family:'DM Mono',monospace;font-size:.62rem;letter-spacing:.12em;text-transform:uppercase;color:var(--ink-f);margin-top:.6rem}
.quip{margin-top:2rem;text-align:center;font-family:'Instrument Serif',Georgia,serif;font-size:1.05rem;font-style:italic;color:var(--ink-m);line-height:1.55;padding-top:1.5rem;border-top:1px solid var(--brd);min-height:2.5em;transition:opacity .4s var(--e)}
.card-rain{position:absolute;inset:0;pointer-events:none;overflow:hidden;border-radius:var(--section-r);z-index:0}
.card-drop{position:absolute;width:1.5px;background:var(--blue-p);opacity:0;border-radius:1px}
@keyframes dropFall{0%{transform:translateY(-12px);opacity:0}8%{opacity:.4}100%{transform:translateY(80px);opacity:0}}
.live-dot{display:inline-flex;align-items:center;gap:.35rem;font-family:'DM Mono',monospace;font-size:.5rem;color:var(--ink-f);letter-spacing:.04em;position:absolute;top:1.2rem;right:1.5rem;z-index:2}
.live-dot::before{content:'';width:5px;height:5px;border-radius:50%;background:var(--blue);animation:livePulse 3s ease-in-out infinite}
.mc.dry .live-dot::before{background:var(--dry)}
@keyframes livePulse{0%,100%{opacity:.4;box-shadow:0 0 0 0 transparent}50%{opacity:1;box-shadow:0 0 6px 2px rgba(61,106,159,.25)}}
.city-label{position:absolute;top:1.2rem;left:1.5rem;font-family:'DM Mono',monospace;font-size:.5rem;color:var(--ink-f);letter-spacing:.08em;text-transform:uppercase;z-index:2}

/* DATA ROW */
.td{display:flex;justify-content:center;gap:2.5rem;margin-top:.25rem}
.di{text-align:center}
.dv{font-family:'Instrument Serif',Georgia,serif;font-size:1.25rem;font-weight:400;color:var(--ink)}
.dl{font-family:'DM Mono',monospace;font-size:.52rem;color:var(--ink-f);letter-spacing:.08em;text-transform:uppercase;margin-top:.15rem}

/* SECTION HEADINGS */
.sec-hd{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:.8rem}
.sec-t{font-family:'Instrument Serif',Georgia,serif;font-size:1.2rem;font-weight:400;color:var(--ink);letter-spacing:-.01em}
.sec-s{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--ink-f)}.sec-s strong{color:var(--ink-m);font-weight:500}

/* BAR CHART */
.bar-g{display:flex;gap:2px;align-items:flex-end;height:65px}
.bw{flex:1;min-width:0;height:100%;display:flex;flex-direction:column;justify-content:flex-end;position:relative}
.bf{width:100%;border-radius:3px 3px 1px 1px;transition:opacity .2s var(--e);transform-origin:bottom;animation:barGrow .5s var(--es) both}
.bf.rb{background:var(--blue);opacity:.5}.bf.rb.hv{opacity:.8}.bf.db{background:var(--ink-g);min-height:3px}
.bw.tb .bf{outline:1.5px solid var(--ink-f);outline-offset:1px;border-radius:3px}
.bw.tb::after{content:'today';position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);font-family:'DM Mono',monospace;font-size:.4rem;color:var(--ink-f);letter-spacing:.04em;white-space:nowrap}
.bw:hover .bf{opacity:1!important}
.bw:hover .tip{opacity:1;transform:translateX(-50%) translateY(0)}
.tip{position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%) translateY(4px);padding:.45rem .7rem;font-size:.6rem;color:var(--ink-s);white-space:nowrap;pointer-events:none;opacity:0;transition:all .2s var(--es);z-index:10;border-radius:10px;background:var(--bg);border:1px solid var(--brd);box-shadow:0 4px 20px rgba(0,0,0,.08)}
.bar-leg{display:flex;gap:.8rem;margin-top:1.1rem;justify-content:flex-end}
.leg-i{display:flex;align-items:center;gap:.25rem;font-family:'DM Mono',monospace;font-size:.52rem;color:var(--ink-f)}
.leg-s{width:8px;height:8px;border-radius:2px}.leg-s.rs{background:var(--blue);opacity:.6}.leg-s.ds{background:var(--ink-g)}
@keyframes barGrow{from{transform:scaleY(0)}to{transform:scaleY(1)}}

/* CALENDAR */
.cal-nav{display:flex;align-items:center;gap:.6rem;margin-bottom:.6rem}
.cal-btn{width:30px;height:30px;border:1px solid var(--brd);border-radius:50%;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--ink-f);transition:all .3s var(--e)}
.cal-btn:hover{border-color:var(--blue-gl);color:var(--blue)}
.cal-btn svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:1.5}
.cal-mo{font-family:'Instrument Serif',Georgia,serif;font-size:1rem;font-weight:400;color:var(--ink);min-width:130px;text-align:center}
.cal-wk{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:2px}
.wkd{text-align:center;font-family:'DM Mono',monospace;font-size:.45rem;color:var(--ink-g);letter-spacing:.06em;text-transform:uppercase;font-weight:400;padding-bottom:3px}
.cal-g{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cell{aspect-ratio:1;border-radius:5px;position:relative;cursor:default;transition:transform .15s var(--e);display:flex;align-items:center;justify-content:center;font-size:.48rem;color:transparent;opacity:0;animation:cellIn .3s var(--es) both}
.cell:not(.em):hover{transform:scale(1.25);z-index:2;color:var(--bg);font-weight:600}
.cell:not(.em):hover .ctip{opacity:1;transform:translateX(-50%) scale(1)}
.cell.em{background:transparent;opacity:1;animation:none}.cell.rc{background:var(--blue);opacity:.5}.cell.rc.hc{opacity:.8}.cell.dc{background:var(--ink-g)}.cell.fc{background:var(--brd);opacity:.35}.cell.toc{outline:2px solid var(--ink-f);outline-offset:1px}
.ctip{position:absolute;bottom:calc(100% + 5px);left:50%;transform:translateX(-50%) scale(.95);padding:.35rem .55rem;font-size:.52rem;color:var(--ink-s);white-space:nowrap;pointer-events:none;opacity:0;transition:all .15s var(--es);z-index:10;border-radius:8px;background:var(--bg);border:1px solid var(--brd);box-shadow:0 4px 16px rgba(0,0,0,.08)}
.cal-st{display:flex;gap:1.25rem;margin-top:.7rem}
.csi{font-family:'DM Mono',monospace;font-size:.58rem;color:var(--ink-f)}.csi strong{color:var(--ink-m);font-weight:500}
@keyframes cellIn{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}

/* DATE LOOKUP */
.lk-row{display:flex;gap:.5rem}
.lk-in{flex:1;padding:.65rem .9rem;font-family:'DM Sans',sans-serif;font-size:.8rem;color:var(--ink-s);background:var(--bg);border:1px solid var(--brd);border-radius:var(--rs);outline:none;transition:all .3s var(--e);-webkit-appearance:none}
.lk-in:focus{border-color:var(--blue-gl);box-shadow:0 0 0 3px var(--blue-w)}
.lk-bt{padding:.65rem 1.3rem;font-family:'DM Mono',monospace;font-size:.68rem;font-weight:400;letter-spacing:.04em;color:#fff;background:var(--blue);border:none;border-radius:var(--rs);cursor:pointer;transition:all .3s var(--e);white-space:nowrap}
.lk-bt:hover{background:var(--blue-h);box-shadow:0 4px 16px rgba(61,106,159,.2);transform:translateY(-1px)}
.lk-bt:active{transform:translateY(0)}.lk-bt:disabled{opacity:.5;cursor:not-allowed;transform:none}
.lk-res{margin-top:.75rem;padding:1rem 1.25rem;display:none;border-radius:var(--rs);background:var(--bg);border:1px solid var(--brd)}
.lk-res.vis{display:block}.lk-res.rr{border-left:3px solid var(--blue)}.lk-res.dr{border-left:3px solid var(--dry)}
.res-t{font-family:'Instrument Serif',Georgia,serif;font-size:.95rem;font-weight:400;color:var(--ink);margin-bottom:.2rem}
.res-b{font-size:.72rem;color:var(--ink-m);line-height:1.6}.res-b strong{color:var(--ink-s);font-weight:500}
.lk-shimmer{margin-top:.75rem;padding:1rem 1.25rem;border-radius:var(--rs);background:var(--bg);border:1px solid var(--brd);overflow:hidden;position:relative}
.lk-shimmer::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,var(--bg-card),transparent);animation:shimmer 1.2s ease-in-out infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.lk-shimmer-line{height:10px;border-radius:4px;background:var(--brd);margin-bottom:.5rem}
.lk-shimmer-line:last-child{width:60%;margin-bottom:0}

/* CUSTOM CITY SEARCH */
.city-search-trigger{display:flex;align-items:center;justify-content:center;gap:.4rem;padding:.8rem;font-family:'DM Mono',monospace;font-size:.6rem;color:var(--ink-f);cursor:pointer;letter-spacing:.03em;transition:color .3s var(--e);border:none;background:none;width:100%;margin-top:-.25rem;margin-bottom:.5rem}
.city-search-trigger:hover{color:var(--blue)}
.city-search-trigger svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:1.5;transition:transform .3s var(--e)}
.city-search-trigger.open svg{transform:rotate(45deg)}
.city-search-trigger:hover svg{color:var(--blue)}
.city-search-panel{overflow:hidden;max-height:0;opacity:0;transition:max-height .5s var(--es),opacity .4s var(--e),margin .4s var(--e);margin-bottom:0}
.city-search-panel.open{max-height:2000px;opacity:1;margin-bottom:1rem}
.city-search-inner{background:var(--bg-card);border-radius:var(--section-r);padding:2rem 2.25rem;border:1px solid var(--brd)}
.cs-title{font-family:'Instrument Serif',Georgia,serif;font-size:1.15rem;font-weight:400;color:var(--ink);margin-bottom:.3rem}
.cs-desc{font-size:.72rem;color:var(--ink-m);margin-bottom:1rem;line-height:1.5}
/* Dropdown */
.cs-dropdown-wrap{position:relative}
.cs-filter{width:100%;padding:.65rem .9rem;padding-right:2.2rem;font-family:'DM Sans',sans-serif;font-size:.8rem;color:var(--ink-s);background:var(--bg);border:1px solid var(--brd);border-radius:var(--rs);outline:none;transition:all .3s var(--e)}
.cs-filter:focus{border-color:var(--blue-gl);box-shadow:0 0 0 3px var(--blue-w)}
.cs-filter::placeholder{color:var(--ink-g)}
.cs-dropdown-arrow{position:absolute;right:.85rem;top:50%;transform:translateY(-50%);width:14px;height:14px;stroke:var(--ink-f);fill:none;stroke-width:1.5;pointer-events:none;transition:transform .3s var(--e)}
.cs-filter:focus ~ .cs-dropdown-arrow{transform:translateY(-50%) rotate(180deg);stroke:var(--blue)}
.cs-list{max-height:0;overflow-y:auto;background:var(--bg);border:1px solid var(--brd);border-radius:var(--rs);box-shadow:0 4px 16px rgba(0,0,0,.06);margin-top:4px;transition:max-height .35s var(--es),opacity .25s var(--e),border-color .25s var(--e);opacity:0;border-color:transparent;scrollbar-width:thin;scrollbar-color:var(--ink-g) transparent}
.cs-list.open{max-height:240px;opacity:1;border-color:var(--brd)}
.cs-list::-webkit-scrollbar{width:4px}.cs-list::-webkit-scrollbar-thumb{background:var(--ink-g);border-radius:2px}
.cs-group-label{position:sticky;top:0;padding:.5rem .9rem .35rem;font-family:'DM Mono',monospace;font-size:.5rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--ink-f);background:var(--bg);border-bottom:1px solid var(--brd);z-index:1}
.cs-option{padding:.5rem .9rem;font-size:.78rem;color:var(--ink-s);cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:background .15s var(--e)}
.cs-option:hover,.cs-option.highlighted{background:var(--blue-w);color:var(--blue)}
.cs-option-country{font-family:'DM Mono',monospace;font-size:.5rem;color:var(--ink-f);letter-spacing:.04em}
.cs-option:hover .cs-option-country{color:var(--blue)}
.cs-option.hidden{display:none}
.cs-no-results{padding:.75rem .9rem;font-size:.72rem;color:var(--ink-f);font-style:italic;text-align:center}
/* Lite result card */
.cs-lite{margin-top:1.25rem;display:none;animation:liteIn .5s var(--es)}
.cs-lite.vis{display:block}
@keyframes liteIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.cs-lite-card{position:relative;overflow:hidden;background:var(--bg);border:1px solid var(--brd);border-radius:var(--r);padding:1.5rem 1.5rem 1.25rem}
.cs-lite-card .mc-mood{border-radius:var(--r)}
.cs-lite-header{display:flex;align-items:flex-start;justify-content:space-between;position:relative;z-index:1;margin-bottom:.8rem}
.cs-lite-city{font-family:'Instrument Serif',Georgia,serif;font-size:1.3rem;font-weight:400;color:var(--ink);line-height:1.15}
.cs-lite-country{font-family:'DM Mono',monospace;font-size:.5rem;color:var(--ink-f);letter-spacing:.06em;text-transform:uppercase;margin-top:.15rem}
.cs-lite-streak{text-align:center;position:relative;z-index:1}
.cs-lite-num{font-family:'Instrument Serif',Georgia,serif;font-size:4.5rem;font-weight:400;line-height:1;letter-spacing:-.04em}
.cs-lite-card.is-rain .cs-lite-num{color:var(--blue)}.cs-lite-card.is-dry .cs-lite-num{color:var(--dry)}
.cs-lite-su{display:block;font-family:'DM Mono',monospace;font-size:.52rem;letter-spacing:.1em;text-transform:uppercase;color:var(--ink-f);margin-top:.25rem}
.cs-lite-data{display:flex;justify-content:center;gap:2rem;margin-top:.6rem;padding-top:.6rem;border-top:1px solid var(--brd);position:relative;z-index:1}
.cs-lite-di{text-align:center}
.cs-lite-dv{font-family:'Instrument Serif',Georgia,serif;font-size:1rem;font-weight:400;color:var(--ink)}
.cs-lite-dl{font-family:'DM Mono',monospace;font-size:.45rem;color:var(--ink-f);letter-spacing:.08em;text-transform:uppercase;margin-top:.1rem}
.cs-lite-bars{margin-top:.8rem;position:relative;z-index:1}
.cs-lite-bars-title{font-family:'DM Mono',monospace;font-size:.48rem;color:var(--ink-f);letter-spacing:.06em;text-transform:uppercase;margin-bottom:.35rem}
.cs-lite-bar-g{display:flex;gap:2px;align-items:flex-end;height:40px}
.cs-lite-quip{text-align:center;font-family:'Instrument Serif',Georgia,serif;font-size:.88rem;font-style:italic;color:var(--ink-m);margin-top:.8rem;padding-top:.7rem;border-top:1px solid var(--brd);position:relative;z-index:1}
.cs-lite-loading{text-align:center;padding:1.5rem;position:relative;z-index:1}
.cs-lite-loading .spinner{width:18px;height:18px;border-width:1.5px;margin-bottom:.5rem}
.cs-lite-loading .load-t{font-size:.78rem}

/* FOOTER */
.pf{padding:2.5rem 0 4rem;margin-top:1rem;display:flex;align-items:center;justify-content:space-between}
.pfl{font-family:'DM Mono',monospace;font-size:.62rem;color:var(--ink-f)}.pfl a{color:var(--ink-m);text-decoration:none;transition:color .3s var(--e)}.pfl a:hover{color:var(--blue)}
.pfr{font-family:'Instrument Serif',Georgia,serif;font-size:.78rem;font-style:italic;color:var(--ink-f)}
.src{font-family:'DM Mono',monospace;font-size:.5rem;color:var(--ink-g);text-align:center;margin-top:.35rem}.src a{color:var(--ink-f);text-decoration:none;border-bottom:1px dotted var(--ink-g)}.src a:hover{color:var(--blue)}

/* UTILITY */
.loading{text-align:center;padding:5rem 1rem}
.spinner{width:24px;height:24px;border:2px solid var(--ink-g);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto .8rem}
@keyframes spin{to{transform:rotate(360deg)}}
.load-t{font-family:'Instrument Serif',Georgia,serif;font-size:.95rem;font-style:italic;color:var(--ink-f)}
.demo-b{display:flex;align-items:center;justify-content:center;gap:.4rem;padding:.6rem 1rem;margin-bottom:1rem;background:var(--dry-w);border:1px solid var(--dry-gl);border-radius:var(--rs);font-family:'DM Mono',monospace;font-size:.6rem;color:var(--dry)}
.demo-b em{font-style:italic;opacity:.7}
#app{transition:opacity .3s var(--e)}
#app.fading{opacity:0}

/* RESPONSIVE */
@media(max-width:600px){
    .page{padding:0 1rem}
    .topbar{padding:.75rem 1rem}
    .scroll-hero{height:125vh}
    .hero-line-1{font-size:3.2rem}
    .hero-line-2{font-size:4.2rem}
    .digit-roller{font-size:6rem}
    .section-panel{padding:2rem 1.5rem;border-radius:22px}
    .live-dot{top:.9rem;right:1.1rem;font-size:.45rem}
    .city-label{top:.9rem;left:1.1rem;font-size:.45rem}
    .lk-row{flex-direction:column}
    .pf{flex-direction:column;gap:.5rem;text-align:center}
    .td{gap:1.5rem}
    .bar-g{height:50px}
}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms!important;transition-duration:.01ms!important}}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--ink-g);border-radius:3px}
</style>
</head>
<body>

<nav class="topbar" id="topbar">
    <a href="../" class="back-link"><svg viewBox="0 0 24 24"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>Lucas Pollock Muguruza</a>
    <div class="topbar-right">
        <button class="icon-btn" id="themeToggle" aria-label="Toggle theme"><svg class="icon-moon" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg><svg class="icon-sun" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/></svg></button>
    </div>
</nav>

<div class="scroll-hero" id="scrollHero">
    <div class="scroll-hero-sticky">
        <div class="hero-text">
            <div class="hero-lbl" id="heroLbl">weather tracker</div>
            <div class="hero-line-1" id="heroL1">did it</div>
            <div class="hero-line-2" id="heroL2">rain?</div>
            <p class="hero-sub" id="heroSub">Tracking consecutive rainy days in London and Manchester. <em>Because someone has to keep score.</em></p>
        </div>
        <div class="scroll-hint" id="scrollHint">
            <span class="scroll-hint-label">scroll</span>
            <div class="scroll-hint-line"></div>
        </div>
    </div>
</div>

<div class="page">
    <div class="city-sw" id="citySw">
        <button class="city-btn active" data-city="london">London</button>
        <button class="city-btn" data-city="manchester">Manchester</button>
    </div>

    <div id="app">
        <div class="loading"><div class="spinner"></div><div class="load-t">checking the skies&hellip;</div></div>
    </div>

    <button class="city-search-trigger" id="csTrigger">
        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        try your own city
    </button>
    <div class="city-search-panel" id="csPanel">
        <div class="city-search-inner">
            <div class="cs-title">What about your city?</div>
            <div class="cs-desc">Pick from 200+ cities worldwide to see their current rain streak.</div>
            <div class="cs-dropdown-wrap" id="csDropWrap">
                <input type="text" class="cs-filter" id="csFilter" placeholder="Search cities&hellip;" autocomplete="off">
                <svg class="cs-dropdown-arrow" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
                <div class="cs-list" id="csList"></div>
            </div>
            <div class="cs-lite" id="csLite"></div>
        </div>
    </div>

    <footer class="pf">
        <div class="pfl"><a href="../">&larr; portfolio</a> &middot; data via <a href="https://open-meteo.com" target="_blank" rel="noopener">Open-Meteo</a></div>
        <div class="pfr" id="footerQuote"></div>
    </footer>
</div>

<script>
(function(){
var C={london:{name:'London',lat:51.5074,lng:-0.1278},manchester:{name:'Manchester',lat:53.4808,lng:-2.2426}};
var TH=0.2,LK=60,BD=30;
var MN=['January','February','March','April','May','June','July','August','September','October','November','December'];
var FQ=["it's always raining somewhere","the sky remembers everything","some call it weather, we call it content","rain is just sky crying because it lives in England","the cloud's PR team is on holiday","umbrella optional, regret guaranteed","the forecast is: British"];
var fqEl=document.getElementById('footerQuote');if(fqEl)fqEl.textContent=FQ[Math.floor(Math.random()*FQ.length)];

var QR=["one rainy day. relatable.","okay two in a row, classic UK behaviour","three days?? the sky is personally targeting you","four days of rain. your socks are never dry again","five straight. this isn't weather, it's a lifestyle","SIX DAYS. the ducks have claimed your garden","seven days. biblically suspicious at this point","a whole week of rain. noah is typing...","genuinely forgot what the sun looks like","double digits of consecutive rain?? touch grass (it's wet)","the umbrella industry is THRIVING rn","at this point the rain is your personality","two weeks of rain. you're basically a fish now","the sun is a myth propagated by Big Sunscreen","honestly the Thames is getting too confident","three weeks?? this is an aquatic civilisation now","the pigeons have evolved gills","rain has won. we acknowledge rain's dominance","a month of rain. water is the new air","this is genuinely unprecedented and also very British"];
var QD=["one dry day. don't get excited","two dry days?? suspicious","three days no rain. the plants are panicking","four days dry. is this... summer??","FIVE dry days in the UK?? screenshot this","six days without rain. scientists are baffled","a WEEK without rain. check if you're still in England","okay this is getting weird now. where's the rain","genuinely concerned. has the sky forgotten how to rain","double digit dry streak. unprecedented scenes","the umbrellas are collecting dust","this is a glitch in the matrix fr","two weeks dry. the grass is filing a complaint","we've entered an alternate timeline apparently","BBC Weather is in shambles rn","three weeks dry?? this violates the terms and conditions of being British","honestly starting to miss the rain","impossible. the simulation is broken","dry for a month. we don't deserve this","this can't last. nothing good ever does"];
function quip(raining,n){var p=raining?QR:QD;var i=Math.min(n-1,p.length-1);return p[Math.max(0,i)]}

var city='london',wc={},isDemo=false,calM=new Date().getMonth(),calY=new Date().getFullYear();
function fmt(d){return d.toISOString().split('T')[0]}

// SCROLL HERO
(function(){
    var lbl=document.getElementById('heroLbl'),l1=document.getElementById('heroL1'),l2=document.getElementById('heroL2'),
        sub=document.getElementById('heroSub'),hint=document.getElementById('scrollHint');
    setTimeout(function(){lbl.classList.add('vis')},100);
    setTimeout(function(){l1.classList.add('vis')},250);
    setTimeout(function(){l2.classList.add('vis')},450);
    setTimeout(function(){sub.classList.add('vis')},650);
    setTimeout(function(){hint.classList.add('vis')},1000);
    var hero=document.getElementById('scrollHero');
    function onScroll(){
        var rect=hero.getBoundingClientRect();
        var progress=Math.min(Math.max(-rect.top/(rect.height-window.innerHeight),0),1);
        lbl.style.transform='translateY('+(progress*-80)+'px)';
        lbl.style.opacity=Math.max(1-progress*3,0);
        l1.style.transform='translateY('+(progress*-60)+'px)';
        l2.style.transform='translateY('+(progress*-35)+'px)';
        sub.style.opacity=Math.max(1-progress*2.5,0);
        hint.style.opacity=Math.max(1-progress*4,0);
        var fadeStart=0.6;
        if(progress>fadeStart){var fo=(progress-fadeStart)/(1-fadeStart);l1.style.opacity=1-fo;l2.style.opacity=1-fo}
    }
    window.addEventListener('scroll',onScroll,{passive:true});
    onScroll();
})();

// INTERSECTION OBSERVER
var revealObs=new IntersectionObserver(function(entries){entries.forEach(function(e){if(e.isIntersecting){e.target.classList.add('revealed');revealObs.unobserve(e.target)}})},{threshold:0.08,rootMargin:'0px 0px -40px 0px'});

// DIGIT ROLLER
function buildRoller(container,targetNum){
    var digits=String(targetNum).split('');container.innerHTML='';var cols=[];
    digits.forEach(function(d){
        var col=document.createElement('div');col.className='digit-col';
        var strip=document.createElement('div');strip.className='digit-strip';
        for(var n=0;n<=9;n++){var s=document.createElement('span');s.textContent=n;strip.appendChild(s)}
        col.appendChild(strip);container.appendChild(col);cols.push({strip:strip,target:parseInt(d)});
    });return cols;
}
function rollTo(cols,step,target){
    var digits=String(step).padStart(String(target).length,'0').split('');
    cols.forEach(function(c,i){c.strip.style.transform='translateY(-'+parseInt(digits[i])+'0%)';c.strip.style.transitionDelay=(i*0.08)+'s'});
}

function apiRaw(lat,lng,s,e){
    var now=new Date(),diff=Math.floor((now-new Date(s))/864e5),errs=[];
    return new Promise(function(resolve,reject){
        function tryF(){if(diff>92)return tryA();var pd=Math.min(diff+1,92);fetch('https://api.open-meteo.com/v1/forecast?latitude='+lat+'&longitude='+lng+'&daily=precipitation_sum&timezone=auto&past_days='+pd+'&forecast_days=1').then(function(r){if(!r.ok)throw new Error('H'+r.status);return r.json()}).then(function(d){if(d.error)throw new Error(d.reason);resolve(filt(d.daily,s,e))}).catch(function(x){errs.push(x.message);tryA()})}
        function tryA(){fetch('https://archive-api.open-meteo.com/v1/archive?latitude='+lat+'&longitude='+lng+'&daily=precipitation_sum&start_date='+s+'&end_date='+e+'&timezone=auto').then(function(r){if(!r.ok)throw new Error('a'+r.status);return r.json()}).then(function(d){if(d.error)throw new Error(d.reason);resolve(d.daily)}).catch(function(x){errs.push(x.message);reject(new Error(errs.join('; ')))})}
        tryF();
    });
}
function api(c,s,e){var ci=C[c];return apiRaw(ci.lat,ci.lng,s,e)}
function filt(d,s,e){var t=[],p=[];d.time.forEach(function(x,i){if(x>=s&&x<=e){t.push(x);p.push(d.precipitation_sum[i])}});return{time:t,precipitation_sum:p}}

/* trimNulls: remove trailing null/undefined entries from parallel arrays */
function trimNulls(times,precip){
    var t=times.slice(),p=precip.slice();
    while(p.length>0&&(p[p.length-1]==null||p[p.length-1]===undefined)){p.pop();t.pop()}
    return{time:t,precipitation_sum:p};
}

function stk(dates,precip){var s=0,r=null;for(var i=dates.length-1;i>=0;i--){var x=precip[i]!=null&&precip[i]>TH;if(r===null){r=x;s=1}else if(x===r)s++;else break}return{streak:s,raining:r}}
function mkDemo(days,ch){var dates=[],precip=[],t=new Date();for(var i=days;i>=0;i--){var d=new Date(t);d.setDate(d.getDate()-i);dates.push(fmt(d));var seed=Math.sin((d.getDate()*31+d.getMonth()*7+13)*9301)*.5+.5;precip.push(seed<ch?+((0.3+seed*8).toFixed(1)):0)}return{dates:dates,precip:precip}}

function render(){
    var data=wc[city];if(!data)return;
    var s=stk(data.dates,data.precip),tp=data.precip[data.precip.length-1]||0,tr=tp>TH;
    var l30=data.precip.slice(-BD),l30d=data.dates.slice(-BD);
    var rc=0;l30.forEach(function(p){if(p!=null&&p>TH)rc++});
    var tm=0;l30.forEach(function(p){tm+=(p||0)});
    var ts=fmt(new Date()),mx=1;l30.forEach(function(p){if((p||0)>mx)mx=p});
    var bars='';
    l30.forEach(function(p,i){var r=p!=null&&p>TH,h=r?Math.max(12,(p/mx)*100):5,it=l30d[i]===ts;var d=new Date(l30d[i]),lb=d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});var del=(i*0.02).toFixed(2);bars+='<div class="bw'+(it?' tb':'')+'"><div class="tip">'+lb+' \u00b7 '+(r?'\u{1F327}\uFE0F '+p.toFixed(1)+'mm':'\u2600\uFE0F dry')+'</div><div class="bf '+(r?'rb':'db')+(r&&p>4?' hv':'')+'" style="height:'+h+'%;animation-delay:'+del+'s"></div></div>'});

    var html=(isDemo?'<div class="demo-b">\u26A0\uFE0F Preview mode \u2014 simulated data. <em>Live data loads on GitHub Pages.</em></div>':'')+
    '<div class="section-panel mc '+(s.raining?'raining':'dry')+'" id="mainCard"><div class="mc-mood"></div>'+(s.raining?'<div class="card-rain" id="cardRain"></div>':'')+
    '<div class="live-dot" id="liveDot">live</div><div class="city-label">'+C[city].name+'</div>'+
    '<div style="text-align:center;position:relative;z-index:1"><div class="pill '+(tr?'rp':'dp')+'"><span class="pdot"></span>'+(tr?'Raining \u00b7 '+tp.toFixed(1)+'mm':'Dry right now')+'</div></div>'+
    '<div class="sd"><div class="digit-roller" id="digitRoller"></div><span class="su">'+(s.raining?'consecutive rainy days':'consecutive dry days')+'</span></div>'+
    '<div class="quip" id="quipText"></div></div>'+
    '<div class="section-panel"><div class="td"><div class="di"><div class="dv">'+tp.toFixed(1)+'mm</div><div class="dl">Today</div></div><div class="di"><div class="dv">'+tm.toFixed(0)+'mm</div><div class="dl">Last 30d</div></div><div class="di"><div class="dv">'+Math.round(rc/BD*100)+'%</div><div class="dl">Rain rate</div></div></div></div>'+
    '<div class="section-panel"><div class="sec-hd"><div class="sec-t">Last 30 days</div><div class="sec-s"><strong>'+rc+'</strong> rainy \u00b7 <strong>'+(BD-rc)+'</strong> dry</div></div><div class="bar-g">'+bars+'</div><div class="bar-leg"><div class="leg-i"><div class="leg-s rs"></div>Rain</div><div class="leg-i"><div class="leg-s ds"></div>Dry</div></div></div>'+
    '<div class="section-panel"><div class="sec-hd"><div class="sec-t">Monthly view</div></div><div class="cal-nav"><button class="cal-btn" onclick="APP.chM(-1)"><svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button><div class="cal-mo" id="calMo"></div><button class="cal-btn" onclick="APP.chM(1)"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg></button></div><div id="calC"></div></div>'+
    '<div class="section-panel"><div class="sec-hd"><div class="sec-t">Check any date</div></div><div class="lk-row"><input type="date" class="lk-in" id="lkD" max="'+ts+'"><button class="lk-bt" id="lkB" onclick="APP.lk()">Check</button></div><div class="lk-res" id="lkR"></div></div>'+
    '<p class="src">Data from <a href="https://open-meteo.com" target="_blank" rel="noopener">Open-Meteo</a> \u00b7 Rain threshold >'+TH+'mm/day</p>';

    document.getElementById('app').innerHTML=html;
    document.querySelectorAll('.section-panel').forEach(function(p){revealObs.observe(p)});

    // DIGIT ROLLER COUNT-UP — deferred until card is visible
    var roller=document.getElementById('digitRoller'),quipEl=document.getElementById('quipText');
    var target=s.streak;
    if(target<=0){roller.textContent='0';return}
    var cols=buildRoller(roller,target);
    rollTo(cols,0,target);

    function startCountUp(){
        var step=0;
        function showStep(){
            step++;if(step>target)return;
            rollTo(cols,step,target);
            quipEl.style.opacity='0';
            var cur=step;
            setTimeout(function(){quipEl.textContent='\u201C'+quip(s.raining,cur)+'\u201D';quipEl.style.opacity='1'},150);
            if(step<target){
                var progress=step/target;var delay;
                if(target<=3){delay=1000}
                else if(progress<0.2){delay=950-progress*500}
                else if(progress<0.45){delay=850-progress*900}
                else if(progress<0.7){delay=460-progress*400}
                else{delay=Math.max(55,200-progress*180)}
                setTimeout(showStep,delay);
            }else{setTimeout(function(){roller.classList.add('breathing')},400)}
        }
        setTimeout(showStep,400);
    }
    // Wait for the card to enter the viewport
    var cardEl=document.getElementById('mainCard');
    var rollerObs=new IntersectionObserver(function(entries){entries.forEach(function(e){if(e.isIntersecting){startCountUp();rollerObs.unobserve(e.target)}})},{threshold:0.15});
    rollerObs.observe(cardEl);

    if(s.raining){var el=document.getElementById('cardRain');if(el)for(var i=0;i<18;i++){var dr=document.createElement('div');dr.className='card-drop';dr.style.left=Math.random()*100+'%';dr.style.height=(6+Math.random()*8)+'px';dr.style.animation='dropFall '+(1.2+Math.random()*1.8)+'s linear '+(Math.random()*3)+'s infinite';el.appendChild(dr)}}
    calM=new Date().getMonth();calY=new Date().getFullYear();renderCal();
    updateMeta(s.raining);
    var dot=document.getElementById('liveDot');if(dot){var now=new Date();dot.textContent='live \u00b7 '+now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}
}

window.APP={};
APP.chM=function(d){calM+=d;if(calM>11){calM=0;calY++}if(calM<0){calM=11;calY--}var now=new Date();if(calY>now.getFullYear()||(calY===now.getFullYear()&&calM>now.getMonth())){calM=now.getMonth();calY=now.getFullYear();return}if(calY<2020){calY=2020;calM=0;return}renderCal()};
function renderCal(){
    var con=document.getElementById('calC'),lab=document.getElementById('calMo');if(!con||!lab)return;
    lab.textContent=MN[calM]+' '+calY;con.innerHTML='<div style="text-align:center;padding:.75rem;font-size:.6rem;color:var(--ink-f);font-family:DM Mono,monospace">Loading\u2026</div>';
    var y=calY,m=calM,start=y+'-'+String(m+1).padStart(2,'0')+'-01',last=new Date(y,m+1,0).getDate(),end=y+'-'+String(m+1).padStart(2,'0')+'-'+String(last).padStart(2,'0'),ts=fmt(new Date()),ae=end>ts?ts:end;
    function build(data){
        var pMap={};data.time.forEach(function(d,i){pMap[d]=data.precipitation_sum[i]});
        var dow=new Date(y,m,1).getDay(),adj=dow===0?6:dow-1,rainD=0,total=0;
        var h='<div class="cal-wk">';['M','T','W','T','F','S','S'].forEach(function(d){h+='<div class="wkd">'+d+'</div>'});h+='</div><div class="cal-g">';
        for(var i=0;i<adj;i++)h+='<div class="cell em"></div>';
        var ci=0;
        for(var d=1;d<=last;d++){var ds=y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0'),p=pMap[ds],isTo=ds===ts,isF=ds>ts,cls='cell',tip='';
        if(isF){cls+=' fc';tip=d+' '+MN[m].slice(0,3)}else if(p!=null&&p!==undefined){var r=p>TH;if(r){rainD++;total+=p;cls+=p>5?' rc hc':' rc';tip=d+' '+MN[m].slice(0,3)+' \u00b7 \u{1F327}\uFE0F '+p.toFixed(1)+'mm'}else{cls+=' dc';tip=d+' '+MN[m].slice(0,3)+' \u00b7 \u2600\uFE0F'}}else{cls+=' dc';tip=d+' '+MN[m].slice(0,3)}
        if(isTo)cls+=' toc';var cd=(ci*0.015).toFixed(3);h+='<div class="'+cls+'" style="animation-delay:'+cd+'s"><span>'+d+'</span><div class="ctip">'+tip+'</div></div>';ci++}
        h+='</div>';var dwd=Object.keys(pMap).length;
        h+='<div class="cal-st"><div class="csi"><strong>'+rainD+'</strong> rainy</div><div class="csi"><strong>'+total.toFixed(0)+'mm</strong> total</div><div class="csi"><strong>'+(dwd?Math.round(rainD/dwd*100):0)+'%</strong> of days</div></div>';con.innerHTML=h;
    }
    if(isDemo){var data={time:[],precipitation_sum:[]};for(var d=1;d<=last;d++){var ds=y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');if(ds>ts)break;data.time.push(ds);var seed=Math.sin((d*31+(m+1)*7+y)*9301)*.5+.5;data.precipitation_sum.push(seed<(city==='manchester'?.52:.45)?+((0.3+seed*8).toFixed(1)):0)}build(data)}
    else{api(city,start,ae).then(build).catch(function(){con.innerHTML='<div style="text-align:center;padding:.75rem;font-size:.65rem;color:var(--ink-f);font-style:italic">Could not load this month.</div>'})}
}
APP.lk=function(){
    var inp=document.getElementById('lkD'),res=document.getElementById('lkR'),btn=document.getElementById('lkB'),ds=inp.value;if(!ds)return;btn.disabled=true;btn.textContent='Checking\u2026';
    res.className='lk-res';res.style.display='none';
    var shimmer=document.createElement('div');shimmer.className='lk-shimmer';shimmer.innerHTML='<div class="lk-shimmer-line"></div><div class="lk-shimmer-line"></div>';
    res.parentNode.insertBefore(shimmer,res.nextSibling);
    function rmShim(){var sh=document.querySelector('.lk-shimmer');if(sh)sh.remove()}
    function show(lp,mp){rmShim();var lr=lp>TH,mr=mp>TH,any=lr||mr;var d=new Date(ds),nice=d.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'});res.className='lk-res vis '+(any?'rr':'dr');res.innerHTML='<div class="res-t">'+nice+'</div><div class="res-b"><strong>London:</strong> '+(lr?'\u{1F327}\uFE0F '+lp.toFixed(1)+'mm':'\u2600\uFE0F No rain')+' \u00b7 <strong>Manchester:</strong> '+(mr?'\u{1F327}\uFE0F '+mp.toFixed(1)+'mm':'\u2600\uFE0F No rain')+'</div>';btn.disabled=false;btn.textContent='Check'}
    function fail(){rmShim();res.className='lk-res vis';res.innerHTML='<div class="res-b" style="font-style:italic;color:var(--ink-f)">Could not fetch data for that date.</div>';btn.disabled=false;btn.textContent='Check'}
    if(isDemo){var seed=ds.split('-').reduce(function(a,b){return a+parseInt(b)},0);var rng=Math.sin(seed*9301)*.5+.5;show(rng<.45?(0.5+rng*6):0,rng<.52?(0.8+rng*7):0)}
    else{Promise.all([api('london',ds,ds),api('manchester',ds,ds)]).then(function(r){show(r[0].precipitation_sum[0]||0,r[1].precipitation_sum[0]||0)}).catch(fail)}
};

document.querySelectorAll('.city-btn').forEach(function(b){b.addEventListener('click',function(){var c=b.dataset.city;if(c===city)return;city=c;document.querySelectorAll('.city-btn').forEach(function(x){x.classList.toggle('active',x.dataset.city===c)});var appEl=document.getElementById('app');appEl.classList.add('fading');setTimeout(function(){render();appEl.classList.remove('fading')},300)})});

// CUSTOM CITY DROPDOWN — 200+ pre-coded cities with lite result card
(function(){
    var CITIES=[
        // WORLD — 100 most populous cities
        {n:'Tokyo',c:'Japan',g:'world',lat:35.6762,lng:139.6503},
        {n:'Delhi',c:'India',g:'world',lat:28.7041,lng:77.1025},
        {n:'Shanghai',c:'China',g:'world',lat:31.2304,lng:121.4737},
        {n:'São Paulo',c:'Brazil',g:'world',lat:-23.5505,lng:-46.6333},
        {n:'Mexico City',c:'Mexico',g:'world',lat:19.4326,lng:-99.1332},
        {n:'Cairo',c:'Egypt',g:'world',lat:30.0444,lng:31.2357},
        {n:'Mumbai',c:'India',g:'world',lat:19.0760,lng:72.8777},
        {n:'Beijing',c:'China',g:'world',lat:39.9042,lng:116.4074},
        {n:'Dhaka',c:'Bangladesh',g:'world',lat:23.8103,lng:90.4125},
        {n:'Osaka',c:'Japan',g:'world',lat:34.6937,lng:135.5023},
        {n:'Karachi',c:'Pakistan',g:'world',lat:24.8607,lng:67.0011},
        {n:'Chongqing',c:'China',g:'world',lat:29.4316,lng:106.9123},
        {n:'Istanbul',c:'Turkey',g:'world',lat:41.0082,lng:28.9784},
        {n:'Buenos Aires',c:'Argentina',g:'world',lat:-34.6037,lng:-58.3816},
        {n:'Kolkata',c:'India',g:'world',lat:22.5726,lng:88.3639},
        {n:'Lagos',c:'Nigeria',g:'world',lat:6.5244,lng:3.3792},
        {n:'Kinshasa',c:'DR Congo',g:'world',lat:-4.4419,lng:15.2663},
        {n:'Manila',c:'Philippines',g:'world',lat:14.5995,lng:120.9842},
        {n:'Tianjin',c:'China',g:'world',lat:39.3434,lng:117.3616},
        {n:'Guangzhou',c:'China',g:'world',lat:23.1291,lng:113.2644},
        {n:'Rio de Janeiro',c:'Brazil',g:'world',lat:-22.9068,lng:-43.1729},
        {n:'Lahore',c:'Pakistan',g:'world',lat:31.5204,lng:74.3587},
        {n:'Bangalore',c:'India',g:'world',lat:12.9716,lng:77.5946},
        {n:'Shenzhen',c:'China',g:'world',lat:22.5431,lng:114.0579},
        {n:'Moscow',c:'Russia',g:'world',lat:55.7558,lng:37.6173},
        {n:'Chennai',c:'India',g:'world',lat:13.0827,lng:80.2707},
        {n:'Bogotá',c:'Colombia',g:'world',lat:4.7110,lng:-74.0721},
        {n:'Jakarta',c:'Indonesia',g:'world',lat:-6.2088,lng:106.8456},
        {n:'Lima',c:'Peru',g:'world',lat:-12.0464,lng:-77.0428},
        {n:'Bangkok',c:'Thailand',g:'world',lat:13.7563,lng:100.5018},
        {n:'Hyderabad',c:'India',g:'world',lat:17.3850,lng:78.4867},
        {n:'Seoul',c:'South Korea',g:'world',lat:37.5665,lng:126.9780},
        {n:'Nagoya',c:'Japan',g:'world',lat:35.1815,lng:136.9066},
        {n:'Chengdu',c:'China',g:'world',lat:30.5728,lng:104.0668},
        {n:'Nanjing',c:'China',g:'world',lat:32.0603,lng:118.7969},
        {n:'Wuhan',c:'China',g:'world',lat:30.5928,lng:114.3055},
        {n:'Ho Chi Minh City',c:'Vietnam',g:'world',lat:10.8231,lng:106.6297},
        {n:'Luanda',c:'Angola',g:'world',lat:-8.8399,lng:13.2894},
        {n:'Ahmedabad',c:'India',g:'world',lat:23.0225,lng:72.5714},
        {n:'Kuala Lumpur',c:'Malaysia',g:'world',lat:3.1390,lng:101.6869},
        {n:'Hong Kong',c:'China',g:'world',lat:22.3193,lng:114.1694},
        {n:'Hangzhou',c:'China',g:'world',lat:30.2741,lng:120.1551},
        {n:'Riyadh',c:'Saudi Arabia',g:'world',lat:24.7136,lng:46.6753},
        {n:'Surat',c:'India',g:'world',lat:21.1702,lng:72.8311},
        {n:'Baghdad',c:'Iraq',g:'world',lat:33.3152,lng:44.3661},
        {n:'Santiago',c:'Chile',g:'world',lat:-33.4489,lng:-70.6693},
        {n:'Pune',c:'India',g:'world',lat:18.5204,lng:73.8567},
        {n:'Singapore',c:'Singapore',g:'world',lat:1.3521,lng:103.8198},
        {n:'Jeddah',c:'Saudi Arabia',g:'world',lat:21.4858,lng:39.1925},
        {n:'Nairobi',c:'Kenya',g:'world',lat:-1.2921,lng:36.8219},
        {n:'Hanoi',c:'Vietnam',g:'world',lat:21.0278,lng:105.8342},
        {n:'Dar es Salaam',c:'Tanzania',g:'world',lat:-6.7924,lng:39.2083},
        {n:'Yangon',c:'Myanmar',g:'world',lat:16.8661,lng:96.1951},
        {n:'Johannesburg',c:'South Africa',g:'world',lat:-26.2041,lng:28.0473},
        {n:'Addis Ababa',c:'Ethiopia',g:'world',lat:9.0250,lng:38.7469},
        {n:'Surabaya',c:'Indonesia',g:'world',lat:-7.2575,lng:112.7521},
        {n:'Cape Town',c:'South Africa',g:'world',lat:-33.9249,lng:18.4241},
        {n:'Casablanca',c:'Morocco',g:'world',lat:33.5731,lng:-7.5898},
        {n:'Melbourne',c:'Australia',g:'world',lat:-37.8136,lng:144.9631},
        {n:'Sydney',c:'Australia',g:'world',lat:-33.8688,lng:151.2093},
        {n:'Taipei',c:'Taiwan',g:'world',lat:25.0330,lng:121.5654},
        {n:'Accra',c:'Ghana',g:'world',lat:5.6037,lng:-0.1870},
        {n:'Kabul',c:'Afghanistan',g:'world',lat:34.5553,lng:69.2075},
        {n:'Khartoum',c:'Sudan',g:'world',lat:15.5007,lng:32.5599},
        {n:'Abidjan',c:'Ivory Coast',g:'world',lat:5.3600,lng:-4.0083},
        {n:'Alexandria',c:'Egypt',g:'world',lat:31.2001,lng:29.9187},
        {n:'Ankara',c:'Turkey',g:'world',lat:39.9334,lng:32.8597},
        {n:'Monterrey',c:'Mexico',g:'world',lat:25.6866,lng:-100.3161},
        {n:'Dubai',c:'UAE',g:'world',lat:25.2048,lng:55.2708},
        {n:'Algiers',c:'Algeria',g:'world',lat:36.7538,lng:3.0588},
        {n:'Medellín',c:'Colombia',g:'world',lat:6.2476,lng:-75.5658},
        {n:'Kampala',c:'Uganda',g:'world',lat:0.3476,lng:32.5825},
        {n:'Dakar',c:'Senegal',g:'world',lat:14.7167,lng:-17.4677},
        {n:'Chittagong',c:'Bangladesh',g:'world',lat:22.3569,lng:91.7832},
        {n:'Havana',c:'Cuba',g:'world',lat:23.1136,lng:-82.3666},
        {n:'Guadalajara',c:'Mexico',g:'world',lat:20.6597,lng:-103.3496},
        {n:'Kunming',c:'China',g:'world',lat:25.0389,lng:102.7183},
        {n:'Changsha',c:'China',g:'world',lat:28.2282,lng:112.9388},
        {n:'Brasília',c:'Brazil',g:'world',lat:-15.7975,lng:-47.8919},
        {n:'Tehran',c:'Iran',g:'world',lat:35.6892,lng:51.3890},
        {n:'Jaipur',c:'India',g:'world',lat:26.9124,lng:75.7873},
        {n:'Lucknow',c:'India',g:'world',lat:26.8467,lng:80.9462},
        {n:'Bandung',c:'Indonesia',g:'world',lat:-6.9175,lng:107.6191},
        {n:'Quito',c:'Ecuador',g:'world',lat:-0.1807,lng:-78.4678},
        {n:'Rawalpindi',c:'Pakistan',g:'world',lat:33.5651,lng:73.0169},
        {n:'Faisalabad',c:'Pakistan',g:'world',lat:31.4504,lng:73.1350},
        {n:'Xiamen',c:'China',g:'world',lat:24.4798,lng:118.0894},
        {n:'Zhengzhou',c:'China',g:'world',lat:34.7466,lng:113.6253},
        {n:'Caracas',c:'Venezuela',g:'world',lat:10.4806,lng:-66.9036},
        {n:'Dalian',c:'China',g:'world',lat:38.9140,lng:121.6147},
        {n:'Santo Domingo',c:'Dominican Rep.',g:'world',lat:18.4861,lng:-69.9312},
        {n:'Kanpur',c:'India',g:'world',lat:26.4499,lng:80.3319},
        {n:'Guatemala City',c:'Guatemala',g:'world',lat:14.6349,lng:-90.5069},
        {n:'Douala',c:'Cameroon',g:'world',lat:4.0511,lng:9.7679},
        {n:'Perth',c:'Australia',g:'world',lat:-31.9505,lng:115.8605},
        {n:'Harbin',c:'China',g:'world',lat:45.8038,lng:126.5350},
        {n:'Auckland',c:'New Zealand',g:'world',lat:-36.8485,lng:174.7633},
        {n:'Amman',c:'Jordan',g:'world',lat:31.9454,lng:35.9284},
        {n:'Guayaquil',c:'Ecuador',g:'world',lat:-2.1710,lng:-79.9224},
        // EUROPE — 50 most populous cities
        {n:'London',c:'UK',g:'europe',lat:51.5074,lng:-0.1278},
        {n:'Berlin',c:'Germany',g:'europe',lat:52.5200,lng:13.4050},
        {n:'Madrid',c:'Spain',g:'europe',lat:40.4168,lng:-3.7038},
        {n:'Rome',c:'Italy',g:'europe',lat:41.9028,lng:12.4964},
        {n:'Paris',c:'France',g:'europe',lat:48.8566,lng:2.3522},
        {n:'Bucharest',c:'Romania',g:'europe',lat:44.4268,lng:26.1025},
        {n:'Vienna',c:'Austria',g:'europe',lat:48.2082,lng:16.3738},
        {n:'Hamburg',c:'Germany',g:'europe',lat:53.5511,lng:9.9937},
        {n:'Warsaw',c:'Poland',g:'europe',lat:52.2297,lng:21.0122},
        {n:'Budapest',c:'Hungary',g:'europe',lat:47.4979,lng:19.0402},
        {n:'Barcelona',c:'Spain',g:'europe',lat:41.3874,lng:2.1686},
        {n:'Munich',c:'Germany',g:'europe',lat:48.1351,lng:11.5820},
        {n:'Milan',c:'Italy',g:'europe',lat:45.4642,lng:9.1900},
        {n:'Prague',c:'Czechia',g:'europe',lat:50.0755,lng:14.4378},
        {n:'Sofia',c:'Bulgaria',g:'europe',lat:42.6977,lng:23.3219},
        {n:'Copenhagen',c:'Denmark',g:'europe',lat:55.6761,lng:12.5683},
        {n:'Stockholm',c:'Sweden',g:'europe',lat:59.3293,lng:18.0686},
        {n:'Amsterdam',c:'Netherlands',g:'europe',lat:52.3676,lng:4.9041},
        {n:'Brussels',c:'Belgium',g:'europe',lat:50.8503,lng:4.3517},
        {n:'Dublin',c:'Ireland',g:'europe',lat:53.3498,lng:-6.2603},
        {n:'Helsinki',c:'Finland',g:'europe',lat:60.1699,lng:24.9384},
        {n:'Athens',c:'Greece',g:'europe',lat:37.9838,lng:23.7275},
        {n:'Lisbon',c:'Portugal',g:'europe',lat:38.7223,lng:-9.1393},
        {n:'Oslo',c:'Norway',g:'europe',lat:59.9139,lng:10.7522},
        {n:'Zagreb',c:'Croatia',g:'europe',lat:45.8150,lng:15.9819},
        {n:'Zurich',c:'Switzerland',g:'europe',lat:47.3769,lng:8.5417},
        {n:'Belgrade',c:'Serbia',g:'europe',lat:44.7866,lng:20.4489},
        {n:'Kyiv',c:'Ukraine',g:'europe',lat:50.4501,lng:30.5234},
        {n:'Manchester',c:'UK',g:'europe',lat:53.4808,lng:-2.2426},
        {n:'Birmingham',c:'UK',g:'europe',lat:52.4862,lng:-1.8904},
        {n:'Naples',c:'Italy',g:'europe',lat:40.8518,lng:14.2681},
        {n:'Turin',c:'Italy',g:'europe',lat:45.0703,lng:7.6869},
        {n:'Cologne',c:'Germany',g:'europe',lat:50.9375,lng:6.9603},
        {n:'Marseille',c:'France',g:'europe',lat:43.2965,lng:5.3698},
        {n:'Lyon',c:'France',g:'europe',lat:45.7640,lng:4.8357},
        {n:'Kraków',c:'Poland',g:'europe',lat:50.0647,lng:19.9450},
        {n:'Valencia',c:'Spain',g:'europe',lat:39.4699,lng:-0.3763},
        {n:'Seville',c:'Spain',g:'europe',lat:37.3891,lng:-5.9845},
        {n:'Edinburgh',c:'UK',g:'europe',lat:55.9533,lng:-3.1883},
        {n:'Glasgow',c:'UK',g:'europe',lat:55.8642,lng:-4.2518},
        {n:'Frankfurt',c:'Germany',g:'europe',lat:50.1109,lng:8.6821},
        {n:'Wrocław',c:'Poland',g:'europe',lat:51.1079,lng:17.0385},
        {n:'Rotterdam',c:'Netherlands',g:'europe',lat:51.9225,lng:4.4792},
        {n:'Thessaloniki',c:'Greece',g:'europe',lat:40.6401,lng:22.9444},
        {n:'Bratislava',c:'Slovakia',g:'europe',lat:48.1486,lng:17.1077},
        {n:'Tallinn',c:'Estonia',g:'europe',lat:59.4370,lng:24.7536},
        {n:'Vilnius',c:'Lithuania',g:'europe',lat:54.6872,lng:25.2797},
        {n:'Riga',c:'Latvia',g:'europe',lat:56.9496,lng:24.1052},
        {n:'Ljubljana',c:'Slovenia',g:'europe',lat:46.0569,lng:14.5058},
        {n:'Reykjavik',c:'Iceland',g:'europe',lat:64.1466,lng:-21.9426},
        // USA — 50 most populous cities
        {n:'New York',c:'USA',g:'usa',lat:40.7128,lng:-74.0060},
        {n:'Los Angeles',c:'USA',g:'usa',lat:34.0522,lng:-118.2437},
        {n:'Chicago',c:'USA',g:'usa',lat:41.8781,lng:-87.6298},
        {n:'Houston',c:'USA',g:'usa',lat:29.7604,lng:-95.3698},
        {n:'Phoenix',c:'USA',g:'usa',lat:33.4484,lng:-112.0740},
        {n:'Philadelphia',c:'USA',g:'usa',lat:39.9526,lng:-75.1652},
        {n:'San Antonio',c:'USA',g:'usa',lat:29.4241,lng:-98.4936},
        {n:'San Diego',c:'USA',g:'usa',lat:32.7157,lng:-117.1611},
        {n:'Dallas',c:'USA',g:'usa',lat:32.7767,lng:-96.7970},
        {n:'San Jose',c:'USA',g:'usa',lat:37.3382,lng:-121.8863},
        {n:'Austin',c:'USA',g:'usa',lat:30.2672,lng:-97.7431},
        {n:'Jacksonville',c:'USA',g:'usa',lat:30.3322,lng:-81.6557},
        {n:'Fort Worth',c:'USA',g:'usa',lat:32.7555,lng:-97.3308},
        {n:'Columbus',c:'USA',g:'usa',lat:39.9612,lng:-82.9988},
        {n:'Charlotte',c:'USA',g:'usa',lat:35.2271,lng:-80.8431},
        {n:'Indianapolis',c:'USA',g:'usa',lat:39.7684,lng:-86.1581},
        {n:'San Francisco',c:'USA',g:'usa',lat:37.7749,lng:-122.4194},
        {n:'Seattle',c:'USA',g:'usa',lat:47.6062,lng:-122.3321},
        {n:'Denver',c:'USA',g:'usa',lat:39.7392,lng:-104.9903},
        {n:'Washington DC',c:'USA',g:'usa',lat:38.9072,lng:-77.0369},
        {n:'Nashville',c:'USA',g:'usa',lat:36.1627,lng:-86.7816},
        {n:'Oklahoma City',c:'USA',g:'usa',lat:35.4676,lng:-97.5164},
        {n:'El Paso',c:'USA',g:'usa',lat:31.7619,lng:-106.4850},
        {n:'Boston',c:'USA',g:'usa',lat:42.3601,lng:-71.0589},
        {n:'Portland',c:'USA',g:'usa',lat:45.5152,lng:-122.6784},
        {n:'Las Vegas',c:'USA',g:'usa',lat:36.1699,lng:-115.1398},
        {n:'Memphis',c:'USA',g:'usa',lat:35.1495,lng:-90.0490},
        {n:'Louisville',c:'USA',g:'usa',lat:38.2527,lng:-85.7585},
        {n:'Baltimore',c:'USA',g:'usa',lat:39.2904,lng:-76.6122},
        {n:'Milwaukee',c:'USA',g:'usa',lat:43.0389,lng:-87.9065},
        {n:'Albuquerque',c:'USA',g:'usa',lat:35.0844,lng:-106.6504},
        {n:'Tucson',c:'USA',g:'usa',lat:32.2226,lng:-110.9747},
        {n:'Fresno',c:'USA',g:'usa',lat:36.7378,lng:-119.7871},
        {n:'Sacramento',c:'USA',g:'usa',lat:38.5816,lng:-121.4944},
        {n:'Mesa',c:'USA',g:'usa',lat:33.4152,lng:-111.8315},
        {n:'Kansas City',c:'USA',g:'usa',lat:39.0997,lng:-94.5786},
        {n:'Atlanta',c:'USA',g:'usa',lat:33.7490,lng:-84.3880},
        {n:'Omaha',c:'USA',g:'usa',lat:41.2565,lng:-95.9345},
        {n:'Colorado Springs',c:'USA',g:'usa',lat:38.8339,lng:-104.8214},
        {n:'Raleigh',c:'USA',g:'usa',lat:35.7796,lng:-78.6382},
        {n:'Miami',c:'USA',g:'usa',lat:25.7617,lng:-80.1918},
        {n:'Minneapolis',c:'USA',g:'usa',lat:44.9778,lng:-93.2650},
        {n:'Cleveland',c:'USA',g:'usa',lat:41.4993,lng:-81.6944},
        {n:'Tampa',c:'USA',g:'usa',lat:27.9506,lng:-82.4572},
        {n:'New Orleans',c:'USA',g:'usa',lat:29.9511,lng:-90.0715},
        {n:'Pittsburgh',c:'USA',g:'usa',lat:40.4406,lng:-79.9959},
        {n:'Cincinnati',c:'USA',g:'usa',lat:39.1031,lng:-84.5120},
        {n:'St. Louis',c:'USA',g:'usa',lat:38.6270,lng:-90.1994},
        {n:'Detroit',c:'USA',g:'usa',lat:42.3314,lng:-83.0458},
        {n:'Honolulu',c:'USA',g:'usa',lat:21.3069,lng:-157.8583}
    ];

    var GROUPS=[{key:'europe',label:'Europe'},{key:'usa',label:'United States'},{key:'world',label:'World'}];

    var trigger=document.getElementById('csTrigger'),panel=document.getElementById('csPanel'),
        filter=document.getElementById('csFilter'),list=document.getElementById('csList'),
        lite=document.getElementById('csLite'),wrap=document.getElementById('csDropWrap');
    var isOpen=false,listOpen=false,hlIdx=-1;

    trigger.addEventListener('click',function(){isOpen=!isOpen;panel.classList.toggle('open',isOpen);trigger.classList.toggle('open',isOpen);if(isOpen)setTimeout(function(){filter.focus()},300)});

    // Build list
    function buildList(){
        var html='';
        GROUPS.forEach(function(g){
            html+='<div class="cs-group-label">'+g.label+'</div>';
            CITIES.forEach(function(ci,i){
                if(ci.g!==g.key)return;
                html+='<div class="cs-option" data-idx="'+i+'"><span>'+ci.n+'</span><span class="cs-option-country">'+ci.c+'</span></div>';
            });
        });
        list.innerHTML=html;
    }
    buildList();

    function showList(){if(!listOpen){listOpen=true;list.classList.add('open');hlIdx=-1}}
    function hideList(){if(listOpen){listOpen=false;list.classList.remove('open');hlIdx=-1}}

    filter.addEventListener('focus',function(){showList();filterList()});
    filter.addEventListener('input',function(){showList();filterList()});
    document.addEventListener('click',function(e){if(!wrap.contains(e.target))hideList()});

    function filterList(){
        var q=filter.value.trim().toLowerCase();
        var opts=list.querySelectorAll('.cs-option');
        var labels=list.querySelectorAll('.cs-group-label');
        var groupVisible={};
        opts.forEach(function(o){
            var ci=CITIES[parseInt(o.dataset.idx)];
            var match=!q||ci.n.toLowerCase().indexOf(q)!==-1||ci.c.toLowerCase().indexOf(q)!==-1;
            o.classList.toggle('hidden',!match);
            if(match)groupVisible[ci.g]=true;
        });
        labels.forEach(function(l){
            var gKey=GROUPS.filter(function(g){return g.label===l.textContent})[0];
            l.style.display=(gKey&&groupVisible[gKey.key])?'':'none';
        });
        // No results?
        var existing=list.querySelector('.cs-no-results');if(existing)existing.remove();
        if(!Object.keys(groupVisible).length){
            var nr=document.createElement('div');nr.className='cs-no-results';nr.textContent='No cities match "'+filter.value.trim()+'"';list.appendChild(nr);
        }
    }

    // Keyboard nav
    filter.addEventListener('keydown',function(e){
        var visible=Array.from(list.querySelectorAll('.cs-option:not(.hidden)'));
        if(!visible.length)return;
        if(e.key==='ArrowDown'){e.preventDefault();hlIdx=Math.min(hlIdx+1,visible.length-1);updateHL(visible)}
        else if(e.key==='ArrowUp'){e.preventDefault();hlIdx=Math.max(hlIdx-1,0);updateHL(visible)}
        else if(e.key==='Enter'&&hlIdx>=0){e.preventDefault();selectCity(parseInt(visible[hlIdx].dataset.idx))}
        else if(e.key==='Escape'){hideList();filter.blur()}
    });
    function updateHL(visible){visible.forEach(function(o,i){o.classList.toggle('highlighted',i===hlIdx)});if(visible[hlIdx])visible[hlIdx].scrollIntoView({block:'nearest'})}

    list.addEventListener('click',function(e){
        var opt=e.target.closest('.cs-option');
        if(opt)selectCity(parseInt(opt.dataset.idx));
    });

    function selectCity(idx){
        var ci=CITIES[idx];
        filter.value=ci.n;
        hideList();
        loadLite(ci);
    }

    function loadLite(ci){
        lite.className='cs-lite vis';
        lite.innerHTML='<div class="cs-lite-card"><div class="mc-mood"></div><div class="cs-lite-loading"><div class="spinner"></div><div class="load-t">checking '+ci.n+'&hellip;</div></div></div>';

        var today=new Date(),past=new Date(today);past.setDate(past.getDate()-(LK+2));
        var s=fmt(past),e=fmt(today);

        apiRaw(ci.lat,ci.lng,s,e).then(function(data){
            var cleaned=trimNulls(data.time,data.precipitation_sum);
            if(!cleaned.time.length)throw new Error('no data');
            var sk=stk(cleaned.time,cleaned.precipitation_sum);
            var tp=cleaned.precipitation_sum[cleaned.precipitation_sum.length-1]||0;
            var tr=tp>TH;

            // Last 14 days for mini bars
            var l14p=cleaned.precipitation_sum.slice(-14),l14d=cleaned.time.slice(-14);
            var l14rain=0,l14total=0;
            l14p.forEach(function(p){if(p!=null&&p>TH)l14rain++;l14total+=(p||0)});
            var mx=1;l14p.forEach(function(p){if((p||0)>mx)mx=p});

            var bars='';
            l14p.forEach(function(p,i){
                var r=p!=null&&p>TH,h=r?Math.max(15,(p/mx)*100):6;
                var del=(i*0.03).toFixed(2);
                var d=new Date(l14d[i]),lb=d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
                bars+='<div class="bw"><div class="tip">'+lb+' \u00b7 '+(r?'\u{1F327}\uFE0F '+p.toFixed(1)+'mm':'\u2600\uFE0F dry')+'</div><div class="bf '+(r?'rb':'db')+'" style="height:'+h+'%;animation-delay:'+del+'s"></div></div>';
            });

            var card=lite.querySelector('.cs-lite-card');
            card.className='cs-lite-card '+(sk.raining?'is-rain':'is-dry');
            var mood=card.querySelector('.mc-mood');
            if(sk.raining){mood.style.background='radial-gradient(ellipse at 30% 20%,rgba(61,106,159,.12),transparent 70%)'}
            else{mood.style.background='radial-gradient(ellipse at 30% 20%,rgba(184,147,90,.1),transparent 70%)'}

            card.innerHTML='<div class="mc-mood" style="'+mood.style.cssText+'"></div>'+
                '<div class="cs-lite-header"><div><div class="cs-lite-city">'+ci.n+'</div><div class="cs-lite-country">'+ci.c+'</div></div>'+
                '<div class="pill '+(tr?'rp':'dp')+'"><span class="pdot"></span>'+(tr?'Rain \u00b7 '+tp.toFixed(1)+'mm':'Dry')+'</div></div>'+
                '<div class="cs-lite-streak"><div class="cs-lite-num">'+sk.streak+'</div>'+
                '<div class="cs-lite-su">'+(sk.raining?'consecutive rainy days':'consecutive dry days')+'</div></div>'+
                '<div class="cs-lite-data"><div class="cs-lite-di"><div class="cs-lite-dv">'+tp.toFixed(1)+'mm</div><div class="cs-lite-dl">Today</div></div>'+
                '<div class="cs-lite-di"><div class="cs-lite-dv">'+l14total.toFixed(0)+'mm</div><div class="cs-lite-dl">Last 14d</div></div>'+
                '<div class="cs-lite-di"><div class="cs-lite-dv">'+Math.round(l14rain/14*100)+'%</div><div class="cs-lite-dl">Rain rate</div></div></div>'+
                '<div class="cs-lite-bars"><div class="cs-lite-bars-title">Last 14 days</div><div class="cs-lite-bar-g">'+bars+'</div></div>'+
                '<div class="cs-lite-quip">\u201C'+quip(sk.raining,sk.streak)+'\u201D</div>';

        }).catch(function(){
            lite.innerHTML='<div class="cs-lite-card"><div style="text-align:center;padding:1.25rem;font-size:.72rem;color:var(--ink-f);font-style:italic">Couldn\u2019t fetch data for '+ci.n+'. Try another city?</div></div>';
        });
    }
})();

function updateMeta(raining){
    var emoji=raining?'\u{1F327}\uFE0F':'\u2600\uFE0F';
    document.title=emoji+' did it rain? \u2014 '+city;
    var c=document.createElement('canvas');c.width=64;c.height=64;
    var ctx=c.getContext('2d');ctx.font='56px serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(raining?'\u{1F327}\uFE0F':'\u2600\uFE0F',32,36);
    var link=document.querySelector("link[rel*='icon']")||document.createElement('link');
    link.rel='icon';link.href=c.toDataURL();document.head.appendChild(link);
}
function init(){var today=new Date(),past=new Date(today);past.setDate(past.getDate()-LK);var s=fmt(past),e=fmt(today);
    Promise.all([api('london',s,e),api('manchester',s,e)]).then(function(r){wc.london={dates:r[0].time,precip:r[0].precipitation_sum};wc.manchester={dates:r[1].time,precip:r[1].precipitation_sum};render()}).catch(function(err){console.warn('API unavailable, using demo data:',err.message);isDemo=true;wc.london=mkDemo(LK,.45);wc.manchester=mkDemo(LK,.52);render()})}
var htmlEl=document.documentElement;
function gT(){var s=localStorage.getItem('rain-theme');if(s==='dark')return'dark';if(s==='light')return'light';return matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'}
function sT(t){t==='dark'?htmlEl.setAttribute('data-theme','dark'):htmlEl.removeAttribute('data-theme')}
sT(gT());
document.getElementById('themeToggle').addEventListener('click',function(){var d=htmlEl.getAttribute('data-theme')==='dark';var n=d?'light':'dark';sT(n);localStorage.setItem('rain-theme',n)});
matchMedia('(prefers-color-scheme:dark)').addEventListener('change',function(e){if(!localStorage.getItem('rain-theme'))sT(e.matches?'dark':'light')});
var tick=false;addEventListener('scroll',function(){if(!tick){requestAnimationFrame(function(){document.getElementById('topbar').classList.toggle('scrolled',scrollY>40);tick=false});tick=true}});
init();
})();
</script>
</body>
</html>
